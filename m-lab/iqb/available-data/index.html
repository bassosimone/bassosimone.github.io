<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>IQB Available Data</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
    margin: 2rem;
    color: #24292f;
    background: #fff;
  }
  h1 {
    font-size: 1.5rem;
    margin-bottom: 0.25rem;
  }
  p.subtitle {
    color: #57606a;
    margin-top: 0;
    margin-bottom: 1.5rem;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    font-size: 0.875rem;
  }
  th, td {
    text-align: left;
    padding: 0.5rem 0.75rem;
    border: 1px solid #d0d7de;
  }
  th {
    background: #f6f8fa;
    font-weight: 600;
    position: sticky;
    top: 0;
  }
  tr:hover {
    background: #f6f8fa;
  }
  a {
    color: #0969da;
    text-decoration: none;
  }
  a:hover {
    text-decoration: underline;
  }
  #error {
    color: #cf222e;
    display: none;
  }
  #loading {
    color: #57606a;
  }
</style>
</head>
<body>

<h1>IQB Available Data</h1>
<p class="subtitle">
  Cached M-Lab query results available for download.
  See <a href="https://github.com/m-lab/iqb">m-lab/iqb</a> for details.
</p>

<p id="loading">Loading manifest&hellip;</p>
<p id="error">Failed to load manifest.</p>

<table id="data-table" hidden>
  <thead>
    <tr>
      <th>Period</th>
      <th>Direction</th>
      <th>Granularity</th>
      <th>File Type</th>
      <th>URL</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
(function () {
  "use strict";

  // Parse a manifest key like:
  //   cache/v1/20241001T000000Z/20241101T000000Z/downloads_by_country_asn/data.parquet
  // into structured columns.
  function parseKey(key) {
    var parts = key.split("/");
    // parts: ["cache", "v1", start, end, queryType, filename]
    if (parts.length !== 6) return null;

    var start = formatDate(parts[2]);
    var end = formatDate(parts[3]);
    var queryType = parts[4];
    var filename = parts[5];

    // Direction: downloads or uploads
    var direction = queryType.startsWith("downloads") ? "downloads" : "uploads";

    // Granularity: everything after "downloads_by_" or "uploads_by_"
    var granularity = queryType.replace(/^(?:downloads|uploads)_by_/, "").replace(/_/g, " + ");

    // File type
    var fileType = filename === "data.parquet" ? "parquet" : "stats.json";

    return {
      period: start + " \u2013 " + end,
      direction: direction,
      granularity: granularity,
      fileType: fileType,
    };
  }

  // Format "20241001T000000Z" as "2024-10"
  function formatDate(s) {
    if (s.length < 6) return s;
    return s.slice(0, 4) + "-" + s.slice(4, 6);
  }

  function render(manifest) {
    var tbody = document.querySelector("#data-table tbody");
    var keys = Object.keys(manifest.files).sort();

    for (var i = 0; i < keys.length; i++) {
      var key = keys[i];
      var entry = manifest.files[key];
      var parsed = parseKey(key);
      if (!parsed) continue;

      var tr = document.createElement("tr");

      var cells = [
        parsed.period,
        parsed.direction,
        parsed.granularity,
        parsed.fileType,
      ];

      for (var j = 0; j < cells.length; j++) {
        var td = document.createElement("td");
        td.textContent = cells[j];
        tr.appendChild(td);
      }

      // URL column with clickable link
      var tdUrl = document.createElement("td");
      var a = document.createElement("a");
      a.href = entry.url;
      a.textContent = key.split("/").slice(2).join("/");
      a.setAttribute("rel", "noopener");
      tdUrl.appendChild(a);
      tr.appendChild(tdUrl);

      tbody.appendChild(tr);
    }

    document.getElementById("loading").hidden = true;
    document.getElementById("data-table").hidden = false;
  }

  fetch("manifest.json")
    .then(function (r) {
      if (!r.ok) throw new Error(r.status);
      return r.json();
    })
    .then(render)
    .catch(function () {
      document.getElementById("loading").hidden = true;
      document.getElementById("error").style.display = "block";
    });
})();
</script>

</body>
</html>
