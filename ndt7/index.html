<!doctype html>
<html lang='en'>
<head>
  <script type='text/javascript' src='ndt7-core.js'></script>
  <style>

.row {
  display: flex;
  flex-direction: row;
  flex-wrap: wrap;
  width: 100%;
}

.result {
  position: relative;
  align-items: center;
  justify-content: center;
  font-size: 1000%;
  align: center;
}
  </style>
  <meta charset='utf-8'>
  <title>ndt7 Speed Test</title>
</head>
<body>
  <div>
    <div id='download' class='result row'>[Download]</div>
    <div id='upload' class='result row'>[Upload]</div>
  </div>
  <script type='text/javascript'>
    /* jshint esversion: 6, asi: true */
    /* globals ndt7core */

    function withElementDo(elementId, callable) {
      const elem = document.getElementById(elementId)
      if (elem) {
        callable(elem)
      }
    }

    function updateView(elementId, appInfo) {
      withElementDo(elementId, function (elem) {
        const elapsed = appInfo.ElapsedTime / 1e06     /* second */
        let speed = appInfo.NumBytes / elapsed         /* B/s    */
        speed *= 8                                     /* bit/s  */
        speed /= 1e06                                  /* Mbit/s */
        elem.innerHTML = speed.toFixed(3) + ' Mbit/s'
      })
    }

    function runSomething(href, testName, callback) {
      ndt7core.run(href, testName, function(ev, val) {
        console.log(ev, val)
        if (ev === 'complete') {
          if (callback !== undefined) {
            callback()
          }
          return
        }
        if (ev === 'measurement' && val.AppInfo !== undefined &&
            val.Origin === 'client') {
          updateView(testName, val.AppInfo)
        }
      })
    }

    function runDownload(href, callback) {
      runSomething(href, 'download', callback)
    }

    function runUpload(href, callback) {
      runSomething(href, 'upload', callback)
    }

    function discoverHostname(href, callback) {
      if (href !== '') {
        // Allow the user to specify a simplified hostname.
        const re = /^mlab[1-9]{1}-[a-z]{3}[0-9]{2}$/
        if (href.match(re)) {
          href = `ndt-iupui-${href}.measurement-lab.org`
        }
        console.log("server: ${href}")
        callback(href)
      }
      fetch('https://locate.measurementlab.net/ndt7')
        .then(function (response) {
          return response.json()
        })
        .then(function (doc) {
          href = doc.fqdn
          console.log("server: ${href}")
          callback(href)
        })
    }

    discoverHostname(window.location.hash, function (href) {
      runDownload(href, function() { runUpload(href); })
    })
  </script>
</body>
</html>
