<!DOCTYPE html>
<html>

<head>
  <title>OONI Sprint Planning</title>
</head>

<body>
  <h1>Sprint Planning</h1>
  <div>Note: we changed the attribution of sprints to months on 2023-10-26 (Sprint 103).</div>
  <div id="nextSprints"></div>
</body>

<script type="text/javascript">
  // millisecondInAWeek is the number of millisecond in a week
  const millisecondInAWeek = 1000 * 60 * 60 * 24 * 7

  // millisecondInADay is the number of millisecond in a day
  const millisecondInADay = 1000 * 60 * 60 * 24

  // monthNames maps a month index to its english name
  const monthNames = ["January", "February", "March", "April", "May", "June",
    "July", "August", "September", "October", "November", "December"
  ]

  // formatDay formats the day string
  const formatDay = function (day) {
    if (day % 10 === 1 && day % 100 !== 11) {
        return day + "st";
    } else if (day % 10 === 2 && day % 100 !== 12) {
        return day + "nd";
    } else if (day % 10 === 3 && day % 100 !== 13) {
        return day + "rd";
    } else {
        return day + "th";
    }
  }

  // formatTwoDates is an helper function to format two dates in a compact way.
  const formatTwoDates = function (begin, end) {
    // Example: 5th - 17th April 2023
    if (begin.getFullYear() === end.getFullYear() && begin.getMonth() === end.getMonth()) {
      return `${formatDay(begin.getDate())} - ${formatDay(end.getDate())} ${monthNames[end.getMonth()]} ${end.getFullYear()}`
    }

    // Example: 27th February - 10th Match 2023
    if (begin.getFullYear() === end.getFullYear()) {
      return `${formatDay(begin.getDate())} ${monthNames[begin.getMonth()]} - ${formatDay(end.getDate())} ${monthNames[end.getMonth()]} ${end.getFullYear()}`
    }

    // Example: 23rd December 2022 - 4th January 2023
    return `${formatDay(begin.getDate())} ${monthNames[begin.getMonth()]} ${begin.getFullYear()} - ${formatDay(end.getDate())} ${monthNames[end.getMonth()]} ${end.getFullYear()}`
  }

  // findRelatedReportingMonth returns the month when the sprint ends. We changed this
  // rule during spring 103, to more easily write monthly reports.
  const findReportingMonth = function (sprintBegin, sprintEnd) {
    return new Date(sprintEnd.getFullYear(), sprintEnd.getMonth(), 1)
  }

  // getSprintInfo returns information on the sprint based on the
  // date passed as argument to this function.
  const getSprintInfo = function (date) {
    // work without mutating the original date object
    date = new Date(date.getTime())

    // make sure we discard the hours and use midnight as the reference
    date.setHours(0, 0, 0, 0)

    // baseSprintDate is the date when the base sprint started
    const baseSprintDate = new Date("2021-12-20")

    // baseSprintNumber is the number of the base sprint
    const baseSprintNumber = 55

    // elapsedMillisec is the elapsed milliseconds between
    // the reference date and today's date
    const elapsedMillisec = date - baseSprintDate

    // elapsedWeeks is the number of weeks elapsed between
    // the reference date and today's date
    const elapsedWeeks = elapsedMillisec / millisecondInAWeek

    // elapsedSprints is the number of elapsed sprints since
    // the reference date and until today
    const elapsedSprints = Math.floor(elapsedWeeks / 2)

    // sprintNumber is the date sprint number
    const sprintNumber = baseSprintNumber + elapsedSprints

    // sprintStarted is when the sprint started
    const sprintStarted = new Date(baseSprintDate.getTime() + (2 * elapsedSprints * millisecondInAWeek))

    // sanity check for the first day of the sprint
    if (sprintStarted.getDay() !== 1) {
      throw new Error("a sprint should start on a Monday")
    }

    // sprintEnded is when the sprint ended
    const sprintEnded = new Date(baseSprintDate.getTime() + (2 * (elapsedSprints + 1) * millisecondInAWeek) - (1 * millisecondInADay))

    // sanity check for the last day of the sprint
    if (sprintEnded.getDay() !== 0) {
      throw new Error("a sprint should end on a Sunday")
    }

    // prepare a string representation of the sprint
    const sprintString = `Sprint ${sprintNumber} (${formatTwoDates(sprintStarted, sprintEnded)})`

    // return info to the caller
    return {
      number: sprintNumber,
      started: sprintStarted,
      ended: sprintEnded,
      stringRepr: sprintString,
    }
  }

  // write information about sprints around this time
  const numSprints = 32
  let currentSprintEnd = null
  for (let idx = -4; idx < numSprints; idx++) {
    const referenceDate = new Date(new Date().getTime() + (2 * idx * millisecondInAWeek))
    const sprintInfo = getSprintInfo(referenceDate)
    var destDiv = document.getElementById("nextSprints")

    if (currentSprintEnd === null || currentSprintEnd.getFullYear() !== sprintInfo.ended.getFullYear() ||
      currentSprintEnd.getMonth() !== sprintInfo.ended.getMonth()) {
      var title = document.createElement("h2")
      title.textContent = `${monthNames[sprintInfo.ended.getMonth()]} ${sprintInfo.ended.getFullYear()}`
      destDiv.appendChild(title)
      currentSprintEnd = sprintInfo.ended
    }

    var sprintText = document.createElement("div")
    sprintText.textContent = `* ${sprintInfo.stringRepr}`
    destDiv.appendChild(sprintText)
  }
</script>

</html>